---
title: "Problem Set 4"
format:
  html:
    embed-resources: true
editor: visual
---

Github link: https://github.com/Soul22238/STATS506/tree/main/ProblemSet4

# Problem 1
```{r}
library(tidyverse)
library(nzelect)
```
## a
```{r}
nzge %>%
  group_by(election_year, voting_type) %>%
  summarise(total_votes = sum(votes, na.rm = TRUE)) %>%
  arrange(desc(total_votes))
```



## b
```{r}
nzge %>%
  filter(election_year == 2014, voting_type == "Candidate") %>%
  group_by(party) %>%
  summarise(votes = sum(votes, na.rm = TRUE)) %>%
  mutate(percent = votes / sum(votes) * 100) %>%
  arrange(desc(percent))
```

## c
```{r}
winners <- nzge %>%
  group_by(election_year, voting_type, party) %>%
  summarise(total_votes = sum(votes, na.rm = TRUE)) %>%
  slice_max(total_votes, n = 1) %>%
  select(election_year, voting_type, winner_party = party)

winners 

```

# Problem 2

## a
There are 128 tournaments in the year 2019
```{r}
matches <- read_csv("atp_matches_2019.txt", show_col_types = FALSE)

tournaments_2019 <- matches %>%
  filter(str_starts(tourney_id, "2019")) %>%
  summarise(count = n_distinct(tourney_id))
print(tournaments_2019)

```


## b
There are 12 winners winning more than one match. The highest record is winning 5 tournaments.
```{r}
winners <- matches %>%
  filter(round == "F") %>%
  group_by(winner_id) %>%
  summarise(counts = n_distinct(tourney_id)) %>%
  filter(counts > 1) %>%
  arrange(desc(counts))
  
winners
```

## c
Given the significance p value (2.2e-16), we can say that there are evidence that
winners have more aces than losers.
```{r}
hypothesis_test_result <- matches %>%

  select(w_ace, l_ace) %>%
  filter(!is.na(w_ace), !is.na(l_ace)) %>%
  
  with(t.test(w_ace, l_ace, 
              paired = TRUE, 
              alternative = "greater")) 


# Display the tidied result table
print(hypothesis_test_result)
```
## d
The players with the highest win-rate are Rafael Nadal, Novak Djokovic, Roger Federer,
Daniil Medvedev, and Kevin Anderson.
```{r}
long_match_data <- matches %>%
  
  bind_rows(
    select(., player_id = winner_id, player_name = winner_name) %>% 
      mutate(is_win = 1),
    select(., player_id = loser_id, player_name = loser_name) %>%
      mutate(is_win = 0)
  )
player_summary <- long_match_data %>%
  
  group_by(player_id, player_name) %>%
  summarise(
    Total_Wins = sum(is_win, na.rm = TRUE), 
    Total_Matches = n(),                   
    .groups = 'drop'                      
  ) %>%
  filter(Total_Matches >= 5)
final_win_rate_ranking <- player_summary %>%
  mutate(Win_Rate = Total_Wins / Total_Matches) %>%
  arrange(desc(Win_Rate)) %>%
  select(player_name, Win_Rate, Total_Wins, Total_Matches, player_id) %>%
  slice_head(n = 5)


final_win_rate_ranking
```

# Problem 3

```{r}
covid <- read.csv("us-states.txt")
head(covid)
```

## a
There is one significant spike and about 4 minor spikes.
```{r}

library(ggplot2)
national_cases <- covid  %>%
  
  mutate(date = as.Date(date)) %>%
  
  group_by(date) %>%
  summarise(
    National_Cases_Avg = sum(cases_avg, na.rm = TRUE), 
    .groups = 'drop'
  )

covid_spikes_plot <- national_cases %>%
  ggplot(aes(x = date, y = National_Cases_Avg)) +
  
  geom_line(color = "darkred", linewidth = 1) +
  
  scale_x_date(
    date_breaks = "6 months",           
    date_labels = "%Y %b"               
  ) +
  
  labs(
    title = "U.S. National COVID-19 Waves",
    subtitle = "7-Day Average New Cases",
    x = "Date",
    y = "Avg. New Cases (National)"
  ) 

print(covid_spikes_plot)
```

## b
I queried chatgpt for the codes in ggplot grammar and revised the codes.
I calculate the total cumulative covid case rate per 100K population for every state and ranks them from highest to lowest to get the highest and lowest overall rates per population.
The main differences are the Maine has a huge spike in 2022, whereas Rhode Island
experience minor spikes at the same time.
```{r}
state_ranking <- covid %>%
  mutate(date = as.Date(date)) %>%
  group_by(state) %>%
  summarise(Cumulative_Rate = sum(cases_avg_per_100k, na.rm = TRUE), .groups = 'drop') %>%
  arrange(desc(Cumulative_Rate))

highest_state_name <- head(state_ranking$state, 1)
lowest_state_name <- tail(state_ranking$state, 1)

comparison_data <- covid %>%
  filter(state %in% c(highest_state_name, lowest_state_name)) %>%
  mutate(date = as.Date(date))

trajectory_plot <- comparison_data %>%
  ggplot(aes(x = date, 
             y = cases_avg_per_100k, 
             color = state)) +

  geom_line()

print(trajectory_plot)
```

## c
The criterion used to define "substantial" is a 7-day average of 150 or more new cases per 100K residents. The top 5 states are North Dakota, South Dakota, Wyoming, Alaska, and Northern Mariana Islands
```{r}

top_5_states_info <- covid %>%
  mutate(date = as.Date(date)) %>%
  filter(cases_avg_per_100k >= 150) %>%
  group_by(state) %>%
  summarise(first_exp = min(date)) %>%
  arrange(first_exp) %>%
  slice_head(n = 5) %>%
  pull(state) 
cat(top_5_states_info)

plot_data_top5 <- covid %>%
  filter(state %in% top_5_states_info) %>%
  mutate(date = as.Date(date)) 

trajectory_plot_top5_avg <- plot_data_top5 %>%
  ggplot(aes(x = date, 
             y = cases_avg_per_100k, 
             color = state)) +
  
  geom_line(linewidth = 1) +
  scale_x_date(date_breaks = "6 months", date_labels = "%Y %b") + 
  
  labs(
    title = "COVID-19 Trajectories: Top 5 Highest Average Daily Rate States",
    subtitle = "Daily Avg. Cases per 100K Population",
    x = "Date",
    y = "Avg. Cases per 100K"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

trajectory_plot_top5_avg
```